<!DOCTYPE html>
<html lang="en" class="profile-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="profile-page">

    <!-- Transparent Navbar -->
    <div class="navbar">
        <a href="/">Home</a> |
        <a href="/shopping.html">Shopping</a> |
        <a href="/fashion.html">Fashion</a> |
        <a href="#">Blog</a> |
        <a href="https://open.spotify.com" target="_blank" rel="noopener noreferrer">Music</a> |
        <a href="/friends.html">Friends</a> |
        <a href="#">Mail</a> |
        <a href="/profile">Profile</a>
    </div>

    <!-- MAIN PROFILE CONTENT -->
    <div class="page-wrapper">
        <div class="container">

            <!-- LEFT COLUMN: Profile Info -->
            <div class="left-column">
                <div class="sidebar" id="profile-sidebar"></div>
            </div>

            <!-- RIGHT COLUMN: Details / Posts / Friends -->
            <div class="main">

                <div class="section-title">About Me</div>
                <p class="profile-blurb" id="about-section"></p>

                <div class="section-title">Interests & Goals</div>
                <p class="profile-blurb" id="interests-section"></p>

                <div class="section-title">Latest Posts</div>
                <div id="posts-section" class="posts-list">
                    <p class="profile-blurb">Loading posts...</p>
                </div>

                <div class="friends-box">
                    <div class="friends-title">Friends</div>
                    <div class="friends-list" id="friends-section">
                        <p>Loading friends...</p>
                    </div>
                </div>

            </div>

        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(location.search);
    const userId = params.get("id");
    if (!userId) return;

    // --- USER INFO ---
    const resUser = await fetch(`/user/${userId}`);
    const user = await resUser.json();

    if (!user || !user.first) {
        document.getElementById("profile-sidebar").innerHTML = "<p>User not found</p>";
        return;
    }

    document.getElementById("profile-sidebar").innerHTML = `
        <img src="${user.image || 'pictures/NGUYEN_MINH.jpg'}" alt="${user.first} ${user.last}">

        <h2>${user.first} ${user.last}</h2>
        <p class="status">"${user.about || ''}"</p>
        <p class="status online">ONLINE!</p>
        <ul class="contact-list">
            <li><a class="contact-button" href="mailto:${user.first}.${user.last}@dartmouth.edu">Send Email</a></li>
            <li><button id="addFriendBtn" class="add-friend-btn contact-button" data-profile-id="${userId}">Add Friend</button></li>
            <li><a class="contact-button" href="#">Message</a></li>
        </ul>
        <div id="friend-picker" class="friend-picker hidden"></div>
    `;

    // --- ADD FRIEND BUTTON LOGIC ---
    async function openFriendPicker() {
        const picker = document.getElementById("friend-picker");
        picker.classList.remove("hidden");
        picker.innerHTML = "<p>Loading profiles...</p>";

        const res = await fetch("/users");
        const users = await res.json();
        if (!res.ok) {
            picker.innerHTML = "<p>Failed to load profiles.</p>";
            return;
        }

        if (!users || users.length === 0) {
            picker.innerHTML = "<p>No other profiles yet.</p>";
            return;
        }

        picker.innerHTML = "";
        users.forEach(u => {
            const row = document.createElement("button");
            row.className = "friend-picker-row";
            row.type = "button";
            row.dataset.friendId = u.id;
            row.innerHTML = `
                <img src="${u.image || '/pictures/NGUYEN_MINH.jpg'}" alt="${u.first} ${u.last}">
                <span>${u.first} ${u.last}</span>
            `;
            row.addEventListener("click", async () => {
                const resAdd = await fetch("/add-friend", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ friendId: u.id })
                });
                const data = await resAdd.json();
                if (resAdd.ok && data.success) {
                    picker.classList.add("hidden");
                    picker.innerHTML = "";
                    loadFriends();
                } else {
                    alert(data.message || "Failed to add friend.");
                }
            });
            picker.appendChild(row);
        });
    }

    document.getElementById("addFriendBtn").addEventListener("click", async () => {
        openFriendPicker();
    });

    // --- RENDER ABOUT / INTERESTS ---
    document.getElementById("about-section").textContent = user.about || "";
    document.getElementById("interests-section").textContent = user.interests || "";

    // --- POSTS LIST ---
    async function loadPosts() {
        const resPosts = await fetch(`/posts/${userId}`);
        const posts = await resPosts.json();
        const postsSection = document.getElementById("posts-section");
        postsSection.innerHTML = "";
        if (!posts || posts.length === 0) {
            postsSection.innerHTML = "<p class='profile-blurb'>No posts yet â€” stay tuned!</p>";
        } else {
            posts.forEach(p => {
                const pEl = document.createElement("p");
                pEl.className = "profile-blurb";
                pEl.textContent = p.content;
                postsSection.appendChild(pEl);
            });
        }
    }
    loadPosts();

    // --- FRIENDS LIST ---
    async function loadFriends() {
        const resFriends = await fetch(`/friends/${userId}`);
        const friends = await resFriends.json();
        const friendsSection = document.getElementById("friends-section");
        friendsSection.innerHTML = "";
        if (!friends || friends.length === 0) {
            friendsSection.innerHTML = "<p>No friends yet</p>";
        } else {
            friends.forEach(f => {
                const imgEl = document.createElement("img");
                imgEl.src = f.image || "/pictures/default-friend.jpg";

                imgEl.alt = `${f.first} ${f.last}`;
                friendsSection.appendChild(imgEl);
            });
        }
    }
    loadFriends();

});
</script>

</body>
</html>
